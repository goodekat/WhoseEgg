---
title: "Applying MDS to the Training Data for WhoseEgg Shiny App"
author: "Katherine Goode <br>"
date: 'Last Updated: `r format(Sys.time(), "%B %d, %Y")`'
output: rmarkdown::github_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

This document contains code that applies multidimensional scaling (MDS) to the random forest training data used in WhoseEgg. The results are used to compare the input data points to the training data points to determine if there are any observations in the input data that are very different from the training data. If there observations that differ, then the random forest may have to extrapolate to make predictions for these observations leading to untrustworthy predictions. 

Note that this method is used as opposed considering each predictor variable individually, because there is moderate to high correlation between some of the variables. The correlation between predictor variables can lead to scenarios where an observation may fall within the range of the marginal distributions of variables but not within the range of the joint distributions. Without MDS, observations that fit in this scenario may be overlooked.

# Setup

Load packages:

```{r}
library(dplyr)
library(ggplot2)
library(gower)
library(purrr)
```

Make a vector of the predictor variables:

```{r}
vars_pred = c(
  "Month",
  "Julian_Day",
  "Temperature",
  "Conductivity",
  "Larval_Length",
  "Membrane_Ave",
  "Membrane_SD",
  "Membrane_CV",
  "Yolk_to_Membrane_Ratio",
  "Yolk_Ave",
  "Yolk_SD",
  "Yolk_CV",
  "Egg_Stage",
  "Compact_Diffuse",
  "Pigment",
  "Sticky_Debris",
  "Deflated"
)
```

Load the egg data:

```{r}
eggdata <- read.csv("../data/eggdata_for_app.csv")
```

Select just the predictor variables:

```{r}
eggdata_preds = eggdata %>% select(all_of(vars_pred))
```

```{r}
str(eggdata_preds)
```

# MDS with Euclidean Distance

```{r}
scale(egg)
```


# MDS with Gower Distance

```{r}
nobs = dim(eggdata_preds)[1]
nobs
```

Compute the Gower distance between each observation and all other observations in the data and put in a list (where each element contains the distances between one observation and all the other observations.)

```{r}
list_of_distances <-
  map(
    .x = 1:nobs,
    .f = function(obs) {
      gower_dist(eggdata_preds, eggdata_preds[obs,])
    }
  )
```

Convert the list of distances to a distance matrix:

```{r}
dist_matrix = matrix(unlist(list_of_distances), ncol = nobs)
```

Apply MDS (specify that the eigenvalues are returned): 

```{r}
mds <- cmdscale(dist_matrix, eig = TRUE, k = 2)
```

```{r}
data.frame(eig = mds$eig) %>%
  mutate(num = 1:n(), prop = eig / sum(eig)) %>%
  ggplot(aes(x = num, y = prop)) + 
  geom_point()
```

```{r}
data.frame(mds$points) %>%
  ggplot(aes(x = X1, y = X2)) + 
  geom_point() + 
  theme(aspect.ratio = 1)
```

Save the MDS results:

```{r}
saveRDS(
  object = mds,
  file = "../data/mds_for_app.rds"
)
```

